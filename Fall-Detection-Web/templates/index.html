<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Fall Detection System</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f4f6f8;
      margin: 0;
      padding: 20px;
    }

    h1 {
      text-align: center;
      color: #333;
      margin-bottom: 30px;
    }

    .main-container {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      gap: 20px;
      flex-wrap: wrap;
    }

    section {
      background-color: #fff;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    .config-section,
    .history-section {
      flex: 1 1 300px;
      max-width: 320px;
    }

    /* C·ªôt video */
    .video-section {
      display: flex;
      flex-direction: column;     /* X·∫øp c√°c ph·∫ßn t·ª≠ theo chi·ªÅu d·ªçc */
      flex: 1 1 400px;            /* C·ªôt video chi·∫øm t·ªëi thi·ªÉu 400px */
      text-align: center;
      position: relative;         /* ƒê·ªÉ c√°c ph·∫ßn t·ª≠ con c√≥ th·ªÉ ƒë∆∞·ª£c ƒë·∫∑t ch√≠nh x√°c */
      height: 100%;               /* Chi·∫øm h·∫øt chi·ªÅu cao c√≥ s·∫µn */
    }

    /* Video container */
    .video-container {
      flex-grow: 1;               /* L√†m cho ph·∫ßn video chi·∫øm h·∫øt kh√¥ng gian c√≤n l·∫°i */
      display: flex;              /* ƒê·∫£m b·∫£o video kh√¥ng b·ªã k√©o d√£n */
      justify-content: center;    /* CƒÉn gi·ªØa video */
    }

    .video-container img {
      max-width: 100%;            /* Gi·ªõi h·∫°n chi·ªÅu r·ªông c·ªßa video */
      height: auto;               /* Gi·ªØ t·ª∑ l·ªá video */
    }

    /* Th√¥ng b√°o ph√°t tri·ªÉn */
    .development-info {
      margin-top: auto;           /* ƒê·∫©y ph·∫ßn th√¥ng b√°o xu·ªëng d∆∞·ªõi c√πng */
      padding: 10px;
      background-color: rgba(0, 0, 0, 0.7);   /* N·ªÅn t·ªëi m·ªù */
      color: white;
      font-size: 14px;
      text-align: center;
      border-top: 2px solid #fff;   /* ƒê∆∞·ªùng vi·ªÅn ph√¢n c√°ch */
      box-sizing: border-box;       /* ƒê·∫£m b·∫£o padding kh√¥ng l√†m thay ƒë·ªïi k√≠ch th∆∞·ªõc */
    }

    /* ƒê·∫£m b·∫£o email l√† link c√≥ m√†u n·ªïi */
    .development-info a {
      color: #ffeb3b;
      text-decoration: none;
    }

    .development-info a:hover {
      text-decoration: underline;
    }


    form {
      margin-top: 15px;
    }

    label {
      display: block;
      margin-top: 10px;
      font-weight: bold;
    }

    input, select, button {
      padding: 10px;
      margin-top: 5px;
      width: 100%;
      box-sizing: border-box;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    button {
      background-color: #007bff;
      color: white;
      border: none;
      cursor: pointer;
    }

    button:hover {
      background-color: #0056b3;
    }

    .checkbox-column {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .checkbox-column label {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: normal;
      white-space: nowrap;        /* NgƒÉn ch·ªØ xu·ªëng d√≤ng */
      padding: 5px 0;
      width: 10px;
    }

    .toggle-btn {
      margin-top: 10px;
      background-color: #17a2b8;
    }

    .toggle-btn:hover {
      background-color: #138496;
    }

    .manager-area {
      display: none;
      margin-top: 10px;
    }

    ul {
      list-style: none;
      padding-left: 0;
      margin-top: 10px;
    }

    li {
      margin: 5px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    li button {
      background-color: #dc3545;
      margin-left: 10px;
    }

    #messageBox {
      position: fixed;
      top: 20px;
      right: 20px;
      background-color: #007bff;
      color: white;
      padding: 10px 20px;
      border-radius: 5px;
      display: none;
      z-index: 1000;
      font-size: 14px;
    }

    img {
      width: 100%;
      max-width: 100%;
      border: 2px solid #333;
      border-radius: 4px;
    }

    .history-container {
      display: flex;
      flex-direction: column;     /* X·∫øp c√°c video theo chi·ªÅu d·ªçc */
      gap: 15px;                  /* Kho·∫£ng c√°ch gi·ªØa c√°c video */
    }

    .history-card {
      background: #f9f9f9;
      border-radius: 5px;
      padding: 10px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    .history-card video {
      width: 100%;            /* ƒê·∫£m b·∫£o video chi·∫øm to√†n b·ªô chi·ªÅu r·ªông c·ªßa container */
      max-width: 300px;       /* K√≠ch th∆∞·ªõc video t·ªëi ƒëa l√† 300px */
      height: auto;           /* T·ª± ƒë·ªông ƒëi·ªÅu ch·ªânh chi·ªÅu cao c·ªßa video */
      margin-bottom: 10px;    /* Kho·∫£ng c√°ch gi·ªØa video v√† c√°c th√¥ng tin */
    }

    .history-card p {
      margin: 5px 0;
    }

    .history-card button {
      background-color: #dc3545;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
    }

    .history-card button:hover {
      background-color: #c82333;
    }
  </style>
</head>
<body>
  <h1>Fall Detection System</h1>
  <div id="messageBox"></div>

  <div class="main-container">
    <!-- C·ªôt c·∫•u h√¨nh -->
    <section class="config-section">
      <h3>‚öôÔ∏è C·∫•u h√¨nh h·ªá th·ªëng</h3>
      <form id="settingsForm">
        <label for="camera_source">Ch·ªçn Camera:</label>
        <select name="camera_source" id="camera_source">
          <option value="0">Laptop Camera</option>
          <option value="1">USB Camera</option>
          <option value="rtsp://admin:QTCDRN@192.168.2.110:554/live1.264">RTSP Camera</option>
          <option value="https://10.213.68.34:8080/video">Phone Camera</option>
          <option value="E:/FallDetection/FallDetection/FallClipsTest/1.avi">Test With Video</option>
        </select>

        <div class="checkbox-column">
          <label><input type="checkbox" name="enable_detection" id="enable_detection" /> Ph√°t hi·ªán ng√£</label>
          <label><input type="checkbox" name="enable_email" id="enable_email" /> G·ª≠i Email</label>
          <label><input type="checkbox" name="enable_sms" id="enable_sms" /> G·ª≠i SMS</label>
        </div>

        <label for="conf">Ng∆∞·ª°ng ph√°t hi·ªán ng∆∞·ªùi (min:0 / max:1):</label>
        <input type="number" name="conf" step="0.01" min="0" max="1" value="0.5" id="conf" required />
      </form>

      <!-- Qu·∫£n l√Ω email -->
      <hr>
      <h4>üìß Email c·∫£nh b√°o</h4>
      <button class="toggle-btn" onclick="toggleManager('email')">üìã Qu·∫£n l√Ω</button>
      <div id="emailManager" class="manager-area">
        <form id="emailForm">
          <input type="email" name="email" placeholder="Th√™m email" required />
          <button type="submit">‚ûï Th√™m</button>
        </form>
        <ul id="emails"></ul>
      </div>

      <!-- Qu·∫£n l√Ω phone -->
      <hr>
      <h4>üìû S·ªë ƒëi·ªán tho·∫°i</h4>
      <button class="toggle-btn" onclick="toggleManager('phone')">üìã Qu·∫£n l√Ω</button>
      <div id="phoneManager" class="manager-area">
        <form id="phoneForm">
          <input type="text" name="phone" placeholder="Th√™m s·ªë ƒëi·ªán tho·∫°i" required />
          <button type="submit">‚ûï Th√™m</button>
        </form>
        <ul id="phones"></ul>
      </div>
    </section>

    <!-- C·ªôt camera -->
    <section class="video-section">
      <h3>üì∫ Truy·ªÅn h√¨nh ·∫£nh th·ªùi gian th·ª±c</h3>
      <img src="{{ url_for('video_feed') }}" alt="Video Feed" />

      <!-- Th√¥ng b√°o v·ªÅ giai ƒëo·∫°n ph√°t tri·ªÉn -->
      <div class="development-info">
        <p><strong>üîß H·ªá th·ªëng ƒëang trong giai ƒëo·∫°n ph√°t tri·ªÉn!</strong></p>
        <p>Ch√∫ng t√¥i r·∫•t tr√¢n tr·ªçng m·ªçi ƒë√≥ng g√≥p, √Ω t∆∞·ªüng ho·∫∑c ph·∫£n h·ªìi ƒë·ªÉ ho√†n thi·ªán h·ªá th·ªëng. </p>
        <p>N·∫øu b·∫°n c√≥ b·∫•t k·ª≥ g√≥p √Ω n√†o, xin vui l√≤ng g·ª≠i email cho ch√∫ng t√¥i: <a href="mailto:huyhoangsuper246@gmail.com">T·∫°i ƒë√¢y</a></p>
      </div>
    </section>

    <!-- C·ªôt l·ªãch s·ª≠ -->
    <section class="history-section">
      <h3>üìΩÔ∏è L·ªãch s·ª≠ ng√£</h3>

      <!-- B·ªô l·ªçc ng√†y -->
      <label for="dateFilter">üìÖ Ch·ªçn ng√†y:</label>
      <input type="date" id="dateFilter" />

      <button onclick="loadHistory()">üîç L·ªçc</button>

      <div class="history-container" id="historyContainer">
        <!-- L·ªãch s·ª≠ s·∫Ω hi·ªÉn th·ªã t·∫°i ƒë√¢y -->
      </div>
    </section>
  </div>

  <!-- JavaScript x·ª≠ l√Ω -->
  <script>
    function showMessage(text, color = "#007bff") {
      const box = document.getElementById("messageBox");
      box.innerText = text;
      box.style.backgroundColor = color;
      box.style.display = "block";
      setTimeout(() => box.style.display = "none", 4000);
    }

    function toggleManager(type) {
      const manager = document.getElementById(type + "Manager");
      manager.style.display = manager.style.display === "block" ? "none" : "block";
    }

    async function loadContacts() {
      const res = await fetch("/get_contacts");
      const data = await res.json();

      const emailList = document.getElementById("emails");
      const phoneList = document.getElementById("phones");
      emailList.innerHTML = "";
      phoneList.innerHTML = "";

      data.emails.forEach(email => {
        emailList.innerHTML += `<li>${email} <button onclick="deleteEmail('${email}')">‚ùå</button></li>`;
      });

      data.phones.forEach(phone => {
        phoneList.innerHTML += `<li>${phone} <button onclick="deletePhone('${phone}')">‚ùå</button></li>`;
      });
    }

    document.getElementById("emailForm").onsubmit = async (e) => {
      e.preventDefault();
      const email = e.target.email.value.trim();
      if (!email) return showMessage("‚ùå Email kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng.", "#dc3545");

      const res = await fetch("/add_email", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email })
      });

      const result = await res.json();
      if (res.ok) {
        showMessage("‚úÖ " + result.message);
        e.target.email.value = '';
        loadContacts();
      } else {
        showMessage("‚ùå " + (result.error || result.message), "#dc3545");
      }
    };

    async function loadHistory(limit = 5) {
      const dateInput = document.getElementById("dateFilter").value;
      const date = dateInput ? dateInput : "";

      const res = await fetch(`/get_alerts?date=${date}`);
      const data = await res.json();

      const container = document.getElementById("historyContainer");
      if (!data || data.length === 0) {
        container.innerHTML = "<p>Kh√¥ng c√≥ c·∫£nh b√°o n√†o.</p>";
        return;
      }

      // üî• Gi·ªõi h·∫°n s·ªë l∆∞·ª£ng video hi·ªÉn th·ªã
      const limitedData = data.slice(0, limit);

      container.innerHTML = limitedData.map((item, idx) => `
        <div class="history-card">
          <video controls>
            <source src="/${item.video}" type="video/mp4">
            Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ video.
          </video>
          <p>üïí Th·ªùi gian: ${item.time}</p>
          <p>üéØ ƒê·ªô tin c·∫≠y: ${item.confidence}</p>
          <button onclick="deleteAlert('${item.time}')">‚ùå Xo√°</button>
        </div>
      `).join("");

      // N·∫øu c√≥ nhi·ªÅu h∆°n limit c·∫£nh b√°o, hi·ªÉn th·ªã n√∫t "Xem th√™m"
      if (data.length > limit) {
        const loadMoreBtn = document.createElement("button");
        loadMoreBtn.innerText = "üìÇ Xem th√™m";
        loadMoreBtn.style.marginTop = "10px";
        loadMoreBtn.onclick = () => loadHistory(limit + 10);  // T·∫£i th√™m 10
        container.appendChild(loadMoreBtn);
      }
    }

    async function deleteAlert(time) {
      if (!confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën xo√° c·∫£nh b√°o n√†y?")) return;

      try {
        const res = await fetch("/delete_alert", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({ time })
        });

        const result = await res.json();

        if (res.ok) {
          showMessage("‚úÖ " + result.message);

          // Xo√° video kh·ªèi DOM ngay l·∫≠p t·ª©c (t√πy ch·ªçn, gi√∫p UI ph·∫£n h·ªìi nhanh h∆°n)
          const videoElement = document.querySelector(`.history-card[data-time="${time}"]`);
          if (videoElement) videoElement.remove();

          loadHistory();  // T·∫£i l·∫°i l·ªãch s·ª≠ sau khi x√≥a
        } else {
          showMessage("‚ùå " + result.message, "#dc3545");
        }
      } catch (error) {
        showMessage("‚ùå L·ªói khi xo√°: " + error.message, "#dc3545");
      }
    }



    // Xo√° l·ªãch s·ª≠ ng√£
    async function deleteHistory(timestamp) {
      try {
        const res = await fetch("/delete_history", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ timestamp })
        });

        const result = await res.json();
        alert(result.message);  // Th√¥ng b√°o k·∫øt qu·∫£
        loadHistory();  // T·∫£i l·∫°i l·ªãch s·ª≠ sau khi x√≥a
      } catch (error) {
        console.error("C√≥ l·ªói x·∫£y ra khi xo√° l·ªãch s·ª≠:", error);
      }
    }

    // Load l·ªãch s·ª≠ khi trang ƒë∆∞·ª£c t·∫£i
    window.onload = loadHistory();

    document.getElementById("phoneForm").onsubmit = async (e) => {
      e.preventDefault();
      const phone = e.target.phone.value.trim();
      if (!phone) return showMessage("‚ùå S·ªë ƒëi·ªán tho·∫°i kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng.", "#dc3545");

      const res = await fetch("/add_phone", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ phone })
      });

      const result = await res.json();
      if (res.ok) {
        showMessage("‚úÖ " + result.message);
        e.target.phone.value = '';
        loadContacts();
      } else {
        showMessage("‚ùå " + (result.error || result.message), "#dc3545");
      }
    };

    async function deleteEmail(email) {
      if (!confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën xo√° email ${email}?")) return;
      const res = await fetch("/delete_email", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email })
      });
      const result = await res.json();
      if (res.ok) {
        showMessage("‚úÖ " + result.message);
        loadContacts();
      } else {
        showMessage("‚ùå " + (result.error || result.message), "#dc3545");
      }
    }

    async function deletePhone(phone) {
      if (!confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën xo√° s·ªë ƒëi·ªán tho·∫°i ${phone}?")) return;
      const res = await fetch("/delete_phone", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ phone })
      });
      const result = await res.json();
      if (res.ok) {
        showMessage("‚úÖ " + result.message);
        loadContacts();
      } else {
        showMessage("‚ùå " + (result.error || result.message), "#dc3545");
      }
    }

    // Load contacts on page load
    window.onload = () => {
      loadContacts();
    };

    async function updateSetting(key, value) {
      try {
        const res = await fetch("/update_settings", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ key, value })
        });

        const result = await res.json();
        if (res.ok) {
          showMessage("‚úÖ " + result.message);
        } else {
          showMessage("‚ùå " + (result.error || result.message), "#dc3545");
        }
      } catch (err) {
        showMessage("‚ùå Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t c·∫•u h√¨nh.", "#dc3545");
      }
    }

    // G·∫Øn s·ª± ki·ªán t·ª± ƒë·ªông c·∫≠p nh·∫≠t c·∫•u h√¨nh
    document.getElementById("camera_source").addEventListener("change", (e) => {
      updateSetting("camera_source", e.target.value);
    });

    document.getElementById("enable_detection").addEventListener("change", (e) => {
      updateSetting("enable_detection", e.target.checked);
    });

    document.getElementById("enable_email").addEventListener("change", (e) => {
      updateSetting("enable_email", e.target.checked);
    });

    document.getElementById("enable_sms").addEventListener("change", (e) => {
      updateSetting("enable_sms", e.target.checked);
    });

    document.querySelector('input[name="conf"]').addEventListener("input", (e) => {
      updateSetting("conf", parseFloat(e.target.value));
    });

    document.getElementById("settingsForm").onsubmit = async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const key = formData.get("camera_source") ? "camera_source" : formData.get("enable_detection") ? "enable_detection" : formData.get("enable_email") ? "enable_email" : "enable_sms";
      const value = formData.get(key);

      const response = await fetch("/update_settings", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ key: key, value: value })
      });

      const result = await response.json();
      if (response.ok) {
        showMessage(result.message);
      } else {
        showMessage("‚ùå " + result.error, "#dc3545");
      }
    };

  </script>
</body>
</html>
